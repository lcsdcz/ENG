<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘é€æŒ‰é’®çŠ¶æ€æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-area {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .input-group {
            margin-bottom: 10px;
        }
        .test-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>å‘é€æŒ‰é’®çŠ¶æ€æµ‹è¯•</h2>
        
        <div class="test-info">
            <h5>æµ‹è¯•è¯´æ˜ï¼š</h5>
            <ul>
                <li>ç‚¹å‡»"æµ‹è¯•å‘é€"æŒ‰é’®æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯</li>
                <li>è§‚å¯Ÿå‘é€æŒ‰é’®æ˜¯å¦ä»"å‘é€ä¸­..."æ¢å¤åˆ°"å‘é€"</li>
                <li>æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ç¡®è®¤çŠ¶æ€å˜åŒ–</li>
            </ul>
        </div>

        <div class="chat-area" id="chatHistory">
            <p class="text-muted">èŠå¤©è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>

        <div class="input-group">
            <textarea 
                id="userInput" 
                class="form-control" 
                placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..."
                rows="3"
            ></textarea>
            <button 
                class="btn btn-primary" 
                type="button" 
                id="sendButton"
            >
                <i class="fas fa-paper-plane me-1"></i>
                å‘é€
            </button>
        </div>

        <div class="mt-3">
            <button class="btn btn-secondary me-2" onclick="testSend()">æµ‹è¯•å‘é€</button>
            <button class="btn btn-warning me-2" onclick="forceReset()">å¼ºåˆ¶é‡ç½®çŠ¶æ€</button>
            <button class="btn btn-info" onclick="checkStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        </div>

        <div class="mt-3">
            <h5>çŠ¶æ€ä¿¡æ¯ï¼š</h5>
            <div id="statusInfo" class="alert alert-info">
                ç­‰å¾…æµ‹è¯•...
            </div>
        </div>
    </div>

    <script>
        class TestAssistant {
            constructor() {
                this.isLoading = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.showLoading(false);
                this.updateStatus();
            }

            setupEventListeners() {
                const sendButton = document.getElementById('sendButton');
                const userInput = document.getElementById('userInput');

                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendMessage());
                }

                if (userInput) {
                    userInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }
            }

            async sendMessage() {
                const userInput = document.getElementById('userInput');
                const message = userInput.value.trim();
                
                if (!message) {
                    alert('è¯·è¾“å…¥å†…å®¹');
                    return;
                }
                
                if (this.isLoading) {
                    alert('è¯·ç­‰å¾…AIå›å¤å®Œæˆ');
                    return;
                }
                
                console.log('Sending message:', message);
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.addMessage('user', message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                userInput.value = '';
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                this.showLoading(true);
                this.updateStatus();
                
                try {
                    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // æ¨¡æ‹ŸAIå›å¤
                    const aiResponse = `è¿™æ˜¯å¯¹"${message}"çš„æ¨¡æ‹Ÿå›å¤ã€‚`;
                    this.addMessage('ai', aiResponse);
                    
                } catch (error) {
                    console.error('æ¨¡æ‹ŸAPIè°ƒç”¨é”™è¯¯:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                } finally {
                    // ç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½é‡ç½®åŠ è½½çŠ¶æ€
                    this.showLoading(false);
                    this.updateStatus();
                    console.log('Loading state reset to false');
                }
            }

            showLoading(show) {
                this.isLoading = show;
                console.log('showLoading called with:', show);
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = show;
                    sendButton.innerHTML = show ? 
                        '<i class="fas fa-spinner fa-spin me-1"></i>å‘é€ä¸­...' : 
                        '<i class="fas fa-paper-plane me-1"></i>å‘é€';
                    console.log('Send button updated:', show ? 'loading' : 'ready');
                } else {
                    console.error('sendButton element not found in showLoading');
                }
            }

            addMessage(role, content) {
                const chatHistory = document.getElementById('chatHistory');
                if (!chatHistory) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert ${role === 'user' ? 'alert-primary' : 'alert-success'}`;
                messageDiv.innerHTML = `
                    <strong>${role === 'user' ? 'ğŸ‘¤ æ‚¨' : 'ğŸ¤– AI'}:</strong> ${content}
                `;
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            forceResetLoading() {
                console.log('Force resetting loading state');
                this.isLoading = false;
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>å‘é€';
                    console.log('Send button force reset to ready state');
                }
                this.updateStatus();
            }

            updateStatus() {
                const statusInfo = document.getElementById('statusInfo');
                if (statusInfo) {
                    statusInfo.innerHTML = `
                        <strong>å½“å‰çŠ¶æ€ï¼š</strong><br>
                        isLoading: ${this.isLoading}<br>
                        æŒ‰é’®çŠ¶æ€: ${this.isLoading ? 'å‘é€ä¸­...' : 'å‘é€'}<br>
                        æŒ‰é’®ç¦ç”¨: ${this.isLoading ? 'æ˜¯' : 'å¦'}
                    `;
                }
            }
        }

        let testAssistant;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            setTimeout(() => {
                console.log('Initializing Test Assistant...');
                testAssistant = new TestAssistant();
            }, 100);
        });

        function testSend() {
            if (testAssistant) {
                testAssistant.sendMessage();
            } else {
                alert('æµ‹è¯•åŠ©æ‰‹æœªåˆå§‹åŒ–');
            }
        }

        function forceReset() {
            if (testAssistant) {
                testAssistant.forceResetLoading();
            } else {
                alert('æµ‹è¯•åŠ©æ‰‹æœªåˆå§‹åŒ–');
            }
        }

        function checkStatus() {
            if (testAssistant) {
                testAssistant.updateStatus();
            } else {
                alert('æµ‹è¯•åŠ©æ‰‹æœªåˆå§‹åŒ–');
            }
        }
    </script>
</body>
</html>
