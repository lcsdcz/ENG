<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发送按钮状态测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-area {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .input-group {
            margin-bottom: 10px;
        }
        .test-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>发送按钮状态测试</h2>
        
        <div class="test-info">
            <h5>测试说明：</h5>
            <ul>
                <li>点击"测试发送"按钮模拟发送消息</li>
                <li>观察发送按钮是否从"发送中..."恢复到"发送"</li>
                <li>检查控制台日志确认状态变化</li>
            </ul>
        </div>

        <div class="chat-area" id="chatHistory">
            <p class="text-muted">聊天记录将显示在这里...</p>
        </div>

        <div class="input-group">
            <textarea 
                id="userInput" 
                class="form-control" 
                placeholder="输入测试消息..."
                rows="3"
            ></textarea>
            <button 
                class="btn btn-primary" 
                type="button" 
                id="sendButton"
            >
                <i class="fas fa-paper-plane me-1"></i>
                发送
            </button>
        </div>

        <div class="mt-3">
            <button class="btn btn-secondary me-2" onclick="testSend()">测试发送</button>
            <button class="btn btn-warning me-2" onclick="forceReset()">强制重置状态</button>
            <button class="btn btn-info" onclick="checkStatus()">检查当前状态</button>
        </div>

        <div class="mt-3">
            <h5>状态信息：</h5>
            <div id="statusInfo" class="alert alert-info">
                等待测试...
            </div>
        </div>
    </div>

    <script>
        class TestAssistant {
            constructor() {
                this.isLoading = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.showLoading(false);
                this.updateStatus();
            }

            setupEventListeners() {
                const sendButton = document.getElementById('sendButton');
                const userInput = document.getElementById('userInput');

                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendMessage());
                }

                if (userInput) {
                    userInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }
            }

            async sendMessage() {
                const userInput = document.getElementById('userInput');
                const message = userInput.value.trim();
                
                if (!message) {
                    alert('请输入内容');
                    return;
                }
                
                if (this.isLoading) {
                    alert('请等待AI回复完成');
                    return;
                }
                
                console.log('Sending message:', message);
                
                // 添加用户消息
                this.addMessage('user', message);
                
                // 清空输入框
                userInput.value = '';
                
                // 显示加载状态
                this.showLoading(true);
                this.updateStatus();
                
                try {
                    // 模拟API调用延迟
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // 模拟AI回复
                    const aiResponse = `这是对"${message}"的模拟回复。`;
                    this.addMessage('ai', aiResponse);
                    
                } catch (error) {
                    console.error('模拟API调用错误:', error);
                    alert('网络错误，请检查网络连接后重试');
                } finally {
                    // 确保在所有情况下都重置加载状态
                    this.showLoading(false);
                    this.updateStatus();
                    console.log('Loading state reset to false');
                }
            }

            showLoading(show) {
                this.isLoading = show;
                console.log('showLoading called with:', show);
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = show;
                    sendButton.innerHTML = show ? 
                        '<i class="fas fa-spinner fa-spin me-1"></i>发送中...' : 
                        '<i class="fas fa-paper-plane me-1"></i>发送';
                    console.log('Send button updated:', show ? 'loading' : 'ready');
                } else {
                    console.error('sendButton element not found in showLoading');
                }
            }

            addMessage(role, content) {
                const chatHistory = document.getElementById('chatHistory');
                if (!chatHistory) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert ${role === 'user' ? 'alert-primary' : 'alert-success'}`;
                messageDiv.innerHTML = `
                    <strong>${role === 'user' ? '👤 您' : '🤖 AI'}:</strong> ${content}
                `;
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            forceResetLoading() {
                console.log('Force resetting loading state');
                this.isLoading = false;
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane me-1"></i>发送';
                    console.log('Send button force reset to ready state');
                }
                this.updateStatus();
            }

            updateStatus() {
                const statusInfo = document.getElementById('statusInfo');
                if (statusInfo) {
                    statusInfo.innerHTML = `
                        <strong>当前状态：</strong><br>
                        isLoading: ${this.isLoading}<br>
                        按钮状态: ${this.isLoading ? '发送中...' : '发送'}<br>
                        按钮禁用: ${this.isLoading ? '是' : '否'}
                    `;
                }
            }
        }

        let testAssistant;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            setTimeout(() => {
                console.log('Initializing Test Assistant...');
                testAssistant = new TestAssistant();
            }, 100);
        });

        function testSend() {
            if (testAssistant) {
                testAssistant.sendMessage();
            } else {
                alert('测试助手未初始化');
            }
        }

        function forceReset() {
            if (testAssistant) {
                testAssistant.forceResetLoading();
            } else {
                alert('测试助手未初始化');
            }
        }

        function checkStatus() {
            if (testAssistant) {
                testAssistant.updateStatus();
            } else {
                alert('测试助手未初始化');
            }
        }
    </script>
</body>
</html>
