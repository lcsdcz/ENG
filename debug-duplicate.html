<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重复消息调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chat-area {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message {
            display: flex;
            margin-bottom: 1rem;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        
        .user-message {
            background: #e3f2fd;
            border-left-color: #2196f3;
            justify-content: flex-end;
        }
        
        .ai-message {
            background: #f1f8e9;
            border-left-color: #4caf50;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-white text-center mb-4">重复消息调试</h2>
        
        <div class="debug-info">
            <strong>调试信息：</strong><br>
            <span id="debugInfo">等待测试...</span>
        </div>

        <div class="chat-area" id="chatHistory">
            <p class="text-muted text-center">聊天记录将显示在这里...</p>
        </div>

        <div class="input-group">
            <textarea 
                id="userInput" 
                class="form-control" 
                placeholder="输入测试消息..."
                rows="2"
            ></textarea>
            <button 
                class="btn btn-primary" 
                type="button" 
                id="sendButton"
            >
                <i class="fas fa-paper-plane me-1"></i>
                发送
            </button>
        </div>

        <div class="mt-3 text-center">
            <button class="btn btn-secondary me-2" onclick="testSimple()">简单测试</button>
            <button class="btn btn-warning me-2" onclick="clearChat()">清空聊天</button>
            <button class="btn btn-info" onclick="showDebugInfo()">显示调试信息</button>
        </div>
    </div>

    <script>
        class DebugAssistant {
            constructor() {
                this.isLoading = false;
                this.messageCount = 0;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateDebugInfo('初始化完成');
            }

            setupEventListeners() {
                const sendButton = document.getElementById('sendButton');
                const userInput = document.getElementById('userInput');

                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendMessage());
                }

                if (userInput) {
                    userInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }
            }

            async sendMessage() {
                const userInput = document.getElementById('userInput');
                const message = userInput.value.trim();
                
                if (!message) {
                    alert('请输入内容');
                    return;
                }
                
                if (this.isLoading) {
                    alert('请等待AI回复完成');
                    return;
                }
                
                this.updateDebugInfo(`发送消息: "${message}"`);
                
                // 添加用户消息
                this.addMessage('user', message);
                
                // 清空输入框
                userInput.value = '';
                
                // 显示加载状态
                this.showLoading(true);
                
                try {
                    // 模拟流式API调用
                    await this.simulateStreamingResponse(message);
                    
                } catch (error) {
                    console.error('模拟API调用错误:', error);
                    this.updateDebugInfo('错误: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async simulateStreamingResponse(userMessage) {
                this.updateDebugInfo('开始流式输出...');
                
                // 创建AI消息占位符
                const placeholder = this.createAIMessagePlaceholder();
                this.updateDebugInfo(`创建占位符: ${placeholder.id}`);
                
                // 模拟AI回复内容
                const response = `Hello! I received your message: "${userMessage}". This is a test response to check for duplicate messages.`;
                
                let fullText = '';
                const words = response.split(' ');
                
                for (const word of words) {
                    fullText += word + ' ';
                    this.updateStreamMessage(placeholder.id, fullText);
                    
                    // 延迟模拟打字
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                this.updateDebugInfo('流式输出完成，调用finalizeStreamMessage');
                this.finalizeStreamMessage(placeholder.id, fullText.trim());
            }

            createAIMessagePlaceholder() {
                const messageId = Date.now();
                const message = {
                    id: messageId,
                    role: 'ai',
                    content: '',
                    timestamp: new Date().toISOString()
                };
                
                this.renderMessage(message);
                this.scrollToBottom();
                return message;
            }

            updateStreamMessage(messageId, text) {
                const el = document.getElementById(`message-${messageId}`);
                if (!el) {
                    this.updateDebugInfo(`错误: 找不到消息元素 ${messageId}`);
                    return;
                }
                
                const textDiv = el.querySelector('.message-text');
                if (!textDiv) {
                    this.updateDebugInfo(`错误: 找不到文本元素 ${messageId}`);
                    return;
                }
                
                textDiv.innerHTML = this.formatMessageText(text);
                this.scrollToBottom();
            }

            finalizeStreamMessage(messageId, finalText) {
                this.updateDebugInfo(`完成消息: ${messageId}, 长度: ${finalText.length}`);
                
                const el = document.getElementById(`message-${messageId}`);
                if (!el) {
                    this.updateDebugInfo(`错误: 找不到消息元素 ${messageId}`);
                    return;
                }
                
                const textDiv = el.querySelector('.message-text');
                if (!textDiv) {
                    this.updateDebugInfo(`错误: 找不到文本元素 ${messageId}`);
                    return;
                }
                
                textDiv.innerHTML = this.formatMessageText(finalText);
                this.scrollToBottom();
                
                this.messageCount++;
                this.updateDebugInfo(`消息完成，总数: ${this.messageCount}`);
            }

            showLoading(show) {
                this.isLoading = show;
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = show;
                    sendButton.innerHTML = show ? 
                        '<i class="fas fa-spinner fa-spin me-1"></i>发送中...' : 
                        '<i class="fas fa-paper-plane me-1"></i>发送';
                }
            }

            addMessage(role, content) {
                const message = {
                    id: Date.now(),
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                this.renderMessage(message);
                this.scrollToBottom();
                this.messageCount++;
                this.updateDebugInfo(`添加消息: ${role}, 总数: ${this.messageCount}`);
            }

            renderMessage(message) {
                const chatHistory = document.getElementById('chatHistory');
                if (!chatHistory) return;
                
                // 检查是否已经存在相同ID的消息
                const existingMessage = document.getElementById(`message-${message.id}`);
                if (existingMessage) {
                    this.updateDebugInfo(`跳过重复消息: ${message.id}`);
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}-message`;
                messageDiv.id = `message-${message.id}`;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.innerHTML = this.formatMessageText(message.content);
                messageDiv.appendChild(textDiv);
                
                chatHistory.appendChild(messageDiv);
                this.updateDebugInfo(`渲染消息: ${message.id}`);
            }

            formatMessageText(text) {
                if (!text) return '';
                return text.replace(/\n/g, '<br>');
            }

            scrollToBottom() {
                const chatHistory = document.getElementById('chatHistory');
                if (chatHistory) {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            }

            updateDebugInfo(info) {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugInfo.innerHTML += `<br>[${timestamp}] ${info}`;
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
                console.log(info);
            }
        }

        let debugAssistant;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugAssistant = new DebugAssistant();
        });

        function testSimple() {
            if (debugAssistant) {
                const userInput = document.getElementById('userInput');
                userInput.value = 'test';
                debugAssistant.sendMessage();
            }
        }

        function clearChat() {
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.innerHTML = '<p class="text-muted text-center">聊天记录已清空...</p>';
            }
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = '聊天已清空';
            }
            if (debugAssistant) {
                debugAssistant.messageCount = 0;
            }
        }

        function showDebugInfo() {
            if (debugAssistant) {
                debugAssistant.updateDebugInfo(`当前状态: 消息总数=${debugAssistant.messageCount}, 加载中=${debugAssistant.isLoading}`);
            }
        }
    </script>
</body>
</html>
